<!DOCTYPE html>
{% load static %}
<html>
<head>
  <meta charset="utf-8"/>
  <title>Run, Santa, Run!</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="text/javascript" src="{% static '3rdparty/qrcode/qrcode.min.js' %}"></script>

  <style>
    .bgd {
      width: 100vw;
      height: 100vh;
      background-color: black;
      color: white;
      user-select: none;
      display: grid;
      grid-template-areas:
        'qr qr qr santa santa santa'
        'text text text text text buttons';
    }
    .qr-div {
      display: grid;
      justify-content: center;
      grid-area: qr;
    }
    .qr {
      width: 500px;
      height: 500px;
      margin-top: 15px;
      padding: 25px;
      background-color: white;
    }
    .santa-div {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      min-height: 10vh;
      min-width: 10vh;
      grid-area: santa;
    }
    .santa-preview {
      background: red;
      width: 25px;
      height: 25px;
    }
    .counter {

    }
    .text {
      grid-area: text;
      font-size: xx-large;
      padding-left: 5%;
    }
    .buttons {
      grid-area: buttons;
    }
    @keyframes jump {
      0% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }
    /* --- 80s cracked game style overlay --- */
    .crack-overlay {
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 9999;
      pointer-events: none; /* don't block clicks */
    }
    .crack-overlay .stamp {
      transform: rotate(-12deg);
      padding: 12px 18px 10px 18px;
      border: 4px double #ff004c;
      color: #ff004c;
      text-transform: uppercase;
      background: rgba(10, 0, 20, 0.25);
      box-shadow: 0 0 10px rgba(255,0,76,0.8), inset 0 0 12px rgba(255,0,76,0.5);
      position: relative;
      backdrop-filter: blur(1px) saturate(1.2);
      image-rendering: pixelated;
      animation: crtFlicker 3.2s infinite steps(60);
    }
    /* subtle scanlines */
    .crack-overlay .stamp::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.07) 0px,
        rgba(255,255,255,0.07) 1px,
        transparent 1px,
        transparent 3px
      );
      mix-blend-mode: overlay;
      pointer-events: none;
    }
    .crack-overlay .line1 {
      font-weight: 900;
      font-size: clamp(28px, 4.5vw, 64px);
      letter-spacing: 6px;
      line-height: 1;
      /* fake CRT chromatic aberration */
      text-shadow:
        2px 0 0 rgba(0,255,255,0.6),
        -2px 0 0 rgba(255,0,255,0.6),
        0 0 8px rgba(255,0,76,0.9),
        0 0 16px rgba(255,0,76,0.6);
      filter: drop-shadow(0 0 6px rgba(255,0,76,0.8));
      animation: glitch 2.2s infinite;
    }
    .crack-overlay .line2 {
      font-weight: 700;
      text-align: right;
      margin-top: -4px;
      font-size: clamp(12px, 1.6vw, 22px);
      letter-spacing: 2px;
      color: #fff;
      text-shadow:
        1px 0 0 rgba(0,255,255,0.5),
        -1px 0 0 rgba(255,0,255,0.5),
        0 0 6px rgba(255,255,255,0.5);
      opacity: 0.95;
    }
    @keyframes glitch {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-1px, 0); }
      11% { transform: translate(1px, 0); }
      12% { transform: translate(0, 0); }
      55% { transform: translate(0, 0); }
      56% { transform: translate(2px, -1px); }
      58% { transform: translate(-2px, 1px); }
      60% { transform: translate(0, 0); }
    }
    @keyframes crtFlicker {
      0% { opacity: 0.95; }
      50% { opacity: 1; }
      51% { opacity: 0.92; }
      52% { opacity: 1; }
      100% { opacity: 0.97; }
    }
  </style>
</head>
<body>
  <!-- 80s cracked-game style overlayer -->
  <div class="crack-overlay">
    <div class="stamp">
      <div class="line1">FORKED</div>
      <div class="line2">by Hendrik</div>
    </div>
  </div>
  <div class="bgd">
    <div class="qr-div">
      <div id="qrcode" class="qr"></div>
      <div>
        <span id="addr-span" onclick="generateQR(window.location.origin + '/click/');"></span>
      </div>
    </div>
    <div class="santa-div">
      <!--<div id="santa" class="santa-preview"></div>-->
      <img id="santa" src="{% static 'images/santa_head.png' %}">
      <div class="counter">
        <span id="num_jumping">0</span> / <span id="num_players">0</span> players are jumping
      </div>
    </div>
    <div class="text">
      <span>RLI-Claus needs your help to bring the many great decarbonisation concepts that his little helpers have produced in his workshop in icy Adlershof to the people.</span><br><br><span>Made by: Moritz, Paul S., Raoul, Stefan</span>
    </div>
    <div class="buttons">
      <a href="{% url 'click' %}" class="btn btn-primary m-1">Push the Button!</a>
      <a href="{% url 'watch' %}" class="btn btn-primary m-1">Watch the Game!</a>
      <a href="{% url 'single_play' %}" class="btn btn-primary m-1">Play Solo!</a>
    </div>
  </div>

  <audio id="lobby-join-audio" src={% static "audio/bell.mp3"%}></audio>
  <audio id="lobby-background-audio" src={% static "audio/lobby_background.mp3"%}></audio>

  <script>
    var should_jump = false;
    var is_jumping = false;
    var num_players = 0;
    const ws_scheme = (window.location.protocol == 'https:') ? 'wss' : 'ws';
    const ws = new WebSocket(ws_scheme +'://' + window.location.host + '/ws/santa/');
    ws.onclose = e => {console.log("Error: socket closed unexpectedly", e);};
    ws.onmessage = m => {
      //console.log(m);
      let data = JSON.parse(m.data)
      let jumping = data["jumping"];
      let players = data["players"];
      document.getElementById("num_jumping").textContent = jumping + "";
      document.getElementById("num_players").textContent = players + "";
      should_jump = jumping >= players / 2 && players > 0;
      if (should_jump)
        jump();
      if (players > num_players) {
        // player joined: play sound
        window.dispatchEvent(new CustomEvent("LobbyJoin"));
      }
      num_players = players;
    };

    function jump() {
      const duration = 1000;  // ms
      if (should_jump && !is_jumping) {
        is_jumping = true;
        document.getElementById("santa").animate([
          {transform: "translateY(0)"},
          {transform: "translateY(-100px)"},
          {transform: "translateY(0)"},
        ], {
          duration: duration,
          iterations: 1,
        });
        // after animation finishes, call jump again
        setTimeout(_ => {
          is_jumping = false;
          jump();
        }, duration);
      }
    }

    var qrcode = null;
    function generateQR(addr) {
      if (qrcode)
        qrcode.makeCode(addr);
      else
        qrcode = new QRCode(document.getElementById("qrcode"), {
          text: addr,
          width : 450,
          height : 450,
        });
      document.getElementById("addr-span").textContent = addr;
    }

    // FIXME: Hardcoded
    let addr = "https://santa-run-django.apps.rl-institut.de/click"
    generateQR(addr);

    // audio
    const audioContext = new AudioContext();
    const lobbyJoinElement = document.getElementById("lobby-join-audio");
    audioContext.createMediaElementSource(lobbyJoinElement).connect(audioContext.destination);
    addEventListener(
      "LobbyJoin",
      _ => {
        lobbyJoinElement.pause();
        lobbyJoinElement.currentTime = 0;
        lobbyJoinElement.play();
      }
    )

    const audioContext2 = new AudioContext();
    const lobbyBackgroundElement = document.getElementById("lobby-background-audio");
    audioContext2.createMediaElementSource(lobbyBackgroundElement).connect(audioContext2.destination);

    {# auto play is not allowed. First the user has to interact with the site.#}
    document.addEventListener("click", function() {
    lobbyBackgroundElement.play();
      lobbyBackgroundElement.volume = 1;
        lobbyBackgroundElement.loop = true
       })


  </script>
</body>
</html>
